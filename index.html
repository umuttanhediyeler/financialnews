<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gündem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-blue': '#344f9e',
              'dark-blue': '#2c4080',
              'medium-blue': '#3e58a8',
              'slate': '#8892b0',
              'light-slate': '#a8b2d1',
              'lightest-slate': '#ccd6f6',
              'brand-orange': '#e84921',
            }
          }
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.1.1",
        "react/": "https://aistudiocdn.com/react@^19.1.1/",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.19.0"
      }
    }
    </script>
  </head>
  <body class="bg-brand-blue">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      // CDN Imports
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";

      // --- services/geminiService.ts ---
      const fetchTurkishFinancialNews = async (ai) => {
        if (!ai) {
          throw new Error("GenAI istemcisi başlatılamadı.");
        }
        try {
          const prompt = `Türkiye'den borsa, döviz ve emtiaları kapsayan en son ve en önemli 8 finans haberini al. Başlık ve özet Türkçe olmalı.`;
          
          const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
              tools: [{googleSearch: {}}],
              temperature: 0.5,
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.ARRAY,
                items: {
                  type: Type.OBJECT,
                  properties: {
                    title: { type: Type.STRING, description: "Makale başlığı, Türkçe." },
                    summary: { type: Type.STRING, description: "Tek cümlelik kısa özet, Türkçe." },
                    url: { type: Type.STRING, description: "Kaynak makalenin direkt URL'si." }
                  },
                  required: ["title", "summary", "url"]
                }
              },
              thinkingConfig: { thinkingBudget: 0 }
            },
          });
          
          const responseText = response.text?.trim();

          if (!responseText) {
            console.error("The AI model returned an empty response.");
            throw new Error("Yapay zeka modeli boş bir yanıt döndürdü. Lütfen daha sonra tekrar deneyin.");
          }
          
          let articles;
          try {
              articles = JSON.parse(responseText);
          } catch (parseError) {
              console.error("JSON parsing error:", parseError, { responseText });
              throw new Error("Haber verileri yapay zeka modelinden ayrıştırılamadı. Format geçersizdi.");
          }

          if (!Array.isArray(articles)) {
            console.error("Parsed data is not an array:", { articles });
            throw new Error("API geçerli bir makale dizisi döndürmedi.");
          }
          
          return articles;

        } catch (error) {
          console.error("Error fetching Turkish financial news:", error);
           if (error.message.includes("API key not valid")) {
              throw new Error("Geçersiz API Anahtarı. Lütfen anahtarınızı kontrol edip tekrar deneyin.");
           }
          if (error instanceof Error && (
              error.message.startsWith("Haber verileri") || 
              error.message.startsWith("API geçerli") ||
              error.message.startsWith("Yapay zeka modeli")
          )) {
              throw error;
          }
          throw new Error("Yapay zeka modelinden haberler alınamadı. Lütfen API anahtarınızı ve bağlantınızı kontrol edin.");
        }
      };

      const streamArticleContent = async (ai, url) => {
        if (!ai) {
          throw new Error("GenAI istemcisi başlatılamadı.");
        }
        try {
          const prompt = `
            As an expert financial analyst, provide a detailed summary of the article at this URL: ${url}.
            The summary must be in Turkish.
            Include key data, financial figures, and any market implications mentioned.
            Structure the summary into multiple paragraphs for clarity.
            Your response should contain ONLY the Turkish summary text, with no extra titles or introductions.
          `;
          
          return ai.models.generateContentStream({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
              tools: [{googleSearch: {}}],
              temperature: 0.2,
            },
          });
        } catch(error) {
          console.error(`Error fetching content for URL ${url}:`, error);
          throw new Error("Makalenin tam içeriği alınamadı.");
        }
      }

      // --- components/LoadingSpinner.tsx ---
      const LoadingSpinner = () => {
        return (
          <div className="flex justify-center items-center py-20">
            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-brand-orange"></div>
          </div>
        );
      };

      // --- components/ErrorMessage.tsx ---
      const ErrorMessage = ({ message }) => {
        return (
          <div className="bg-red-900/50 border border-red-600 text-red-100 px-4 py-3 rounded-md relative text-center" role="alert">
            <strong className="font-bold">Hata!</strong>
            <span className="block sm:inline ml-2">{message}</span>
          </div>
        );
      };

      // --- components/NewsCard.tsx ---
      const NewsCard = ({ article, onSelect }) => {
        return (
          <button
            onClick={() => onSelect(article)}
            className="group bg-dark-blue rounded-lg shadow-lg overflow-hidden flex flex-col h-full text-left transition-transform duration-300 ease-in-out hover:-translate-y-1 hover:shadow-2xl hover:shadow-brand-orange/10 w-full focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange p-5"
            aria-label={`Read more about ${article.title}`}
          >
            <h2 className="text-lg font-bold text-lightest-slate mb-2 flex-grow">
              {article.title}
            </h2>
            <p className="text-slate text-sm mb-4">
              {article.summary}
            </p>
            <div className="mt-auto">
              <span
                className="inline-block text-lightest-slate font-medium py-2 px-4 border border-lightest-slate rounded-md group-hover:text-brand-orange group-hover:border-brand-orange transition-colors duration-300 text-sm"
              >
                Daha Fazla Oku
              </span>
            </div>
          </button>
        );
      };

      // --- components/NewsDetail.tsx ---
      const NewsDetail = ({ article, isLoading, error, onClose }) => {
        const [isShowing, setIsShowing] = useState(false);

        useEffect(() => {
          const timer = setTimeout(() => setIsShowing(true), 10);
          return () => clearTimeout(timer);
        }, []);

        useEffect(() => {
          const handleKeyDown = (event) => {
            if (event.key === 'Escape') {
              handleClose();
            }
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => {
            window.removeEventListener('keydown', handleKeyDown);
          };
        }, [onClose]);

        const handleClose = () => {
          setIsShowing(false);
          setTimeout(onClose, 300); // Wait for animation to complete
        };

        return (
          <div
            className={`fixed inset-0 z-40 transition-opacity duration-300 ease-in-out ${isShowing ? 'opacity-100' : 'opacity-0'}`}
            onClick={handleClose}
            aria-modal="true"
            role="dialog"
            aria-labelledby="article-title"
          >
            <div className="absolute inset-0 bg-brand-blue/80 backdrop-blur-sm" />
            <div
              className={`fixed inset-y-0 right-0 w-full max-w-2xl bg-dark-blue shadow-2xl z-50 transform transition-transform duration-300 ease-in-out flex flex-col ${isShowing ? 'translate-x-0' : 'translate-x-full'}`}
              onClick={(e) => e.stopPropagation()}
            >
              <header className="p-4 flex items-center justify-between border-b border-lightest-slate/20 flex-shrink-0">
                <div className="flex items-center overflow-hidden">
                  <button
                    onClick={handleClose}
                    className="p-2 -ml-2 sm:ml-0 mr-2 rounded-full text-slate hover:bg-medium-blue hover:text-brand-orange transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange flex-shrink-0"
                    aria-label="Geri dön"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <h2 id="article-title" className="text-xl font-bold text-lightest-slate truncate" title={article.title}>{article.title}</h2>
                </div>
                <button
                  onClick={handleClose}
                  className="p-2 ml-4 rounded-full text-slate hover:bg-medium-blue hover:text-brand-orange transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange flex-shrink-0"
                  aria-label="Makaleyi kapat"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </header>
              <div className="overflow-y-auto p-6 flex-grow">
                {isLoading && <LoadingSpinner />}
                {error && <ErrorMessage message={error} />}
                {article.content && (
                  <div className="text-light-slate space-y-4">
                    {article.content.split('\n').filter(p => p.trim() !== '').map((paragraph, index) => (
                      <p key={index}>{paragraph}</p>
                    ))}
                  </div>
                )}
                {article.sources && article.sources.length > 0 && (
                  <div className="mt-8 pt-4 border-t border-lightest-slate/20">
                    <h3 className="text-lg font-semibold text-slate mb-3">Kaynaklar</h3>
                    <ul className="list-disc list-inside space-y-2">
                      {article.sources.map((source, index) => (
                        <li key={index} className="text-sm truncate">
                          <a href={source.uri} target="_blank" rel="noopener noreferrer" className="text-brand-orange hover:underline">
                            {source.title || source.uri}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };
      
      // --- App.tsx ---
      const ai = new GoogleGenAI({ apiKey: AIzaSyB460wHiXfCTjMRjmz7dw73hgSCJEekMGo });

      const App = () => {
        const [articles, setArticles] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [error, setError] = useState(null);

        const [selectedArticle, setSelectedArticle] = useState(null);
        const [isDetailLoading, setIsDetailLoading] = useState(false);
        const [detailError, setDetailError] = useState(null);

        useEffect(() => {
          const getNews = async () => {
            try {
              setIsLoading(true);
              setError(null);
              const newsArticles = await fetchTurkishFinancialNews(ai);
              setArticles(newsArticles);
            } catch (err) {
              if (err instanceof Error) {
                setError(err.message);
              } else {
                setError('Bilinmeyen bir hata oluştu.');
              }
            } finally {
              setIsLoading(false);
            }
          };

          getNews();
        }, []); // Run only once on mount

        useEffect(() => {
          if (selectedArticle) {
            document.body.style.overflow = 'hidden';
          } else {
            document.body.style.overflow = 'auto';
          }
          return () => {
            document.body.style.overflow = 'auto';
          };
        }, [selectedArticle]);


        const handleSelectArticle = async (article) => {
          if (article.content) {
            setSelectedArticle(article);
            return;
          }

          setSelectedArticle({ ...article, content: '', sources: [] });
          setIsDetailLoading(true);
          setDetailError(null);

          try {
            const stream = await streamArticleContent(ai, article.url);
            setIsDetailLoading(false); 
            
            let fullContent = '';
            const sources = new Map();

            for await (const chunk of stream) {
              const chunkText = chunk.text;
              if (chunkText) {
                fullContent += chunkText;
                setSelectedArticle(prev => prev ? ({ ...prev, content: fullContent }) : null);
              }

              const groundingChunks = chunk.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
              groundingChunks.forEach(c => {
                  if (c.web?.uri && !sources.has(c.web.uri)) {
                      sources.set(c.web.uri, { uri: c.web.uri, title: c.web.title || '' });
                  }
              });
              
              if(sources.size > 0) {
                 setSelectedArticle(prev => prev ? ({ ...prev, sources: Array.from(sources.values()) }) : null);
              }
            }

            const finalSources = Array.from(sources.values());
            const updatedArticle = { ...article, content: fullContent, sources: finalSources };
            setArticles(prevArticles =>
              prevArticles.map(a => a.url === article.url ? updatedArticle : a)
            );

          } catch (err) {
            const errorMessage = (err instanceof Error) ? err.message : 'Makale alınırken bilinmeyen bir hata oluştu.';
            setDetailError(errorMessage);
            setIsDetailLoading(false);
          }
        };

        const handleCloseDetail = () => {
          setSelectedArticle(null);
        };

        const renderContent = () => {
          if (isLoading) {
            return <LoadingSpinner />;
          }
          if (error) {
            return <ErrorMessage message={error} />;
          }
          if (articles.length === 0) {
            return <p className="text-center text-slate">Haber bulunamadı.</p>;
          }
          return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 lg:gap-8">
              {articles.map((article, index) => (
                <NewsCard key={article.url || index} article={article} onSelect={handleSelectArticle} />
              ))}
            </div>
          );
        };

        return (
          <div className="min-h-screen bg-brand-blue font-sans text-lightest-slate relative overflow-x-hidden">
            <main className="container mx-auto p-4 md:p-6 lg:p-8 pt-8 md:pt-12">
              {renderContent()}
            </main>
            <footer className="text-center py-4 mt-8">
              <p className="text-slate text-sm">
                Finansal veriler AI ile işlenmiştir.
              </p>
            </footer>
            
            {selectedArticle && (
              <NewsDetail 
                article={selectedArticle}
                isLoading={isDetailLoading}
                error={detailError}
                onClose={handleCloseDetail}
              />
            )}
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
      }
    </script>
  </body>
</html>
